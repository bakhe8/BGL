# Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† - ØªÙˆØ«ÙŠÙ‚ Ø´Ø§Ù…Ù„

> **Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«**: 2025-12-17  
> **Ø§Ù„Ø¥ØµØ¯Ø§Ø±**: 4.0 (Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø³ÙŠØ·)  
> **Ø§Ù„Ø­Ø§Ù„Ø©**: ğŸ”„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« - Refactoring in Progress

---

## ğŸ“‹ Ø§Ù„ÙÙ‡Ø±Ø³

1. [Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©](#Ù†Ø¸Ø±Ø©-Ø¹Ø§Ù…Ø©)
2. [Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (Before)](#Ø§Ù„ÙˆØ¶Ø¹-Ø§Ù„Ø­Ø§Ù„ÙŠ-before)
3. [Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙˆØ§Ù„ØªØ¹Ù‚ÙŠØ¯Ø§Øª](#Ø§Ù„Ù…Ø´Ø§ÙƒÙ„-ÙˆØ§Ù„ØªØ¹Ù‚ÙŠØ¯Ø§Øª)
4. [Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­ (After)](#Ø§Ù„Ø­Ù„-Ø§Ù„Ù…Ù‚ØªØ±Ø­-after)
5. [Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©](#Ø®Ø·Ø©-Ø§Ù„ØªÙ†ÙÙŠØ°-Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©)
6. [Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ±Ø§Ø¬Ø¹](#Ù…Ø±Ø¬Ø¹-Ø§Ù„ØªØ±Ø§Ø¬Ø¹)

---

## ğŸ¯ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

### Ù…Ø§ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ

Ù†Ø¸Ø§Ù… ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙÙŠ Ø¹Ø¯Ø© Ù…Ø±Ø§Ø­Ù„:
1. **Ø§Ø³ØªÙŠØ±Ø§Ø¯** Ø£Ø³Ù…Ø§Ø¡ Ù…Ù† Ù…Ù„ÙØ§Øª Excel
2. **Ù…Ø·Ø§Ø¨Ù‚Ø©** Ù…Ø¹ Ø§Ù„Ù‚ÙˆØ§Ù…ÙŠØ³ Ø§Ù„Ø±Ø³Ù…ÙŠØ©
3. **ØªØ¹Ù„Ù…** Ù…Ù† Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
4. **Ø§Ù‚ØªØ±Ø§Ø­** Ø£Ø³Ù…Ø§Ø¡ Ø°ÙƒÙŠØ© Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
5. **Ù†Ø´Ø±** Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø©

### Ù„Ù…Ø§Ø°Ø§ Ø§Ù„ØªØºÙŠÙŠØ±ØŸ

| Ø§Ù„Ù…Ø´ÙƒÙ„Ø© | Ø§Ù„ØªØ£Ø«ÙŠØ± |
|---------|---------|
| Ø§Ù„Ù…Ù†Ø·Ù‚ Ù…Ø¹Ù‚Ø¯ Ø¬Ø¯Ø§Ù‹ | ØµØ¹ÙˆØ¨Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ± |
| Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØªØªÙƒØ±Ø± | Ø¨Ø·Ø¡ ÙÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡ |
| Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù…ØªØ¯Ø§Ø®Ù„Ø© | ØµØ¹ÙˆØ¨Ø© Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„ÙÙ‡Ù… |
| Ù„Ø§ Ø³Ø¬Ù„ Ù„Ù„Ù‚Ø±Ø§Ø±Ø§Øª | Ù„Ø§ Ù†Ø¹Ø±Ù Ù…ØµØ¯Ø± ÙƒÙ„ Ø§Ø³Ù… |

---

## ğŸ“Š Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (Before)

### Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. suppliers                                               â”‚
â”‚     â””â”€ id, official_name                                    â”‚
â”‚     â””â”€ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†                              â”‚
â”‚                                                             â”‚
â”‚  2. supplier_alternative_names                              â”‚
â”‚     â””â”€ supplier_id, alternative_name                        â”‚
â”‚     â””â”€ Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø¯ÙŠÙ„Ø© ÙŠØ¯ÙˆÙŠØ©                                    â”‚
â”‚                                                             â”‚
â”‚  3. supplier_aliases_learning                               â”‚
â”‚     â””â”€ original_supplier_name                               â”‚
â”‚     â””â”€ normalized_supplier_name                             â”‚
â”‚     â””â”€ linked_supplier_id                                   â”‚
â”‚     â””â”€ usage_count, last_used_at                            â”‚
â”‚     â””â”€ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…                    â”‚
â”‚                                                             â”‚
â”‚  4. imported_records                                        â”‚
â”‚     â””â”€ raw_supplier_name (Ù…Ù† Excel)                         â”‚
â”‚     â””â”€ supplier_id (Ø§Ù„Ù…Ø®ØªØ§Ø±)                                â”‚
â”‚     â””â”€ supplier_display_name (Ù„Ù„Ø¹Ø±Ø¶)                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ØªØ¯ÙÙ‚ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ:

#### 1. Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:
```
Excel â†’ import.php
  â”‚
  â–¼
INSERT INTO imported_records (
    raw_supplier_name = "ABC TRADING CO",
    supplier_id = NULL,
    supplier_display_name = NULL
)
```

#### 2. Ø¹Ù†Ø¯ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù‚Ø±Ø§Ø±:
```
decision.php?record_id=123
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CandidateService->supplierCandidates()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€ Query 1: SELECT FROM suppliers WHERE name LIKE...
        â”œâ”€â”€ Query 2: SELECT FROM supplier_alternative_names WHERE...
        â”œâ”€â”€ Query 3: SELECT FROM supplier_aliases_learning WHERE...
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ù„ÙƒÙ„ Ù†ØªÙŠØ¬Ø©:                            â”‚
â”‚   - Calculate Levenshtein distance    â”‚
â”‚   - Calculate base score              â”‚
â”‚   - Get usage stats                   â”‚
â”‚   - Calculate bonus points            â”‚
â”‚   - Assign star rating                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sort by total_score DESC              â”‚
â”‚ Return top 6 candidates               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©**: ÙƒÙ„ Ù‡Ø°Ø§ ÙŠØ­Ø¯Ø« **ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©** ÙŠÙØªØ­ ÙÙŠÙ‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø¬Ù„!

#### 3. Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸:
```
User clicks Save â†’ process_update.php
        â”‚
        â”œâ”€â”€ UPDATE imported_records SET supplier_id = X
        â”‚
        â”œâ”€â”€ INSERT/UPDATE supplier_aliases_learning
        â”‚   (create or increment usage)
        â”‚
        â””â”€â”€ UPDATE imported_records 
            WHERE session_id = same AND raw_name = same
            AND supplier_id IS NULL
            (propagation)
```

### Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ù†ÙŠØ©:

| Ø§Ù„Ù…Ù„Ù | Ø§Ù„Ø¯ÙˆØ± |
|-------|------|
| `www/decision.php` | Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© + ØªÙˆÙ„ÙŠØ¯ Candidates |
| `www/process_update.php` | Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø± + Ø§Ù„ØªØ¹Ù„Ù… + Ø§Ù„Ù†Ø´Ø± |
| `app/Services/CandidateService.php` | Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ… |
| `app/Repositories/SupplierLearningRepository.php` | Ø§Ù„ØªØ¹Ù„Ù… ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… |
| `app/Repositories/SupplierRepository.php` | Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø±Ø³Ù…ÙŠ |
| `app/Repositories/SupplierAlternativeNameRepository.php` | Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© |

---

## âš ï¸ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙˆØ§Ù„ØªØ¹Ù‚ÙŠØ¯Ø§Øª

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1: Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©

```
Ø§Ù„Ø³Ø¬Ù„ 12028 ÙŠÙÙØªØ­ 5 Ù…Ø±Ø§Øª = 5 Ã— (3 queries + fuzzy matching + scoring)

Ù„Ùˆ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ†Ø§ 100 Ø³Ø¬Ù„ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…:
  = 100 Ã— Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª!
```

**Ø§Ù„Ø­Ù„**: Cache Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø¬Ø¯ÙˆÙ„.

---

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 2: Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ù€ Scoring Ù…ØªØ¯Ø§Ø®Ù„Ø§Ù†

```
supplier_aliases_learning ÙŠØ­ØªÙˆÙŠ:
  - original_name â†’ linked_supplier_id (Ù„Ù„ØªØ¹Ù„Ù…)
  - usage_count, last_used_at (Ù„Ù„Ù€ Scoring)

Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯ = ØºØ±Ø¶Ø§Ù† Ù…Ø®ØªÙ„ÙØ§Ù† = ØµØ¹ÙˆØ¨Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©
```

**Ø§Ù„Ø­Ù„**: ÙØµÙ„Ù‡Ù…Ø§ ÙÙŠ Ø¬Ø¯ÙˆÙ„ÙŠÙ†.

---

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 3: Ù„Ø§ Ø³Ø¬Ù„ Ù„Ù„Ù‚Ø±Ø§Ø±Ø§Øª

```
Ø§Ù„Ø³Ø¤Ø§Ù„: Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŒ Ù…Ù† Ø£ÙŠÙ† Ø¬Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ ÙÙŠÙ‡ØŸ
- Ù…Ù† ExcelØŸ
- Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ
- Ù…Ù† PropagationØŸ
- Ù…Ù† Ø§Ù„ØªØ¹Ù„Ù…ØŸ

Ø§Ù„Ø¬ÙˆØ§Ø¨: Ù„Ø§ Ù†Ø¹Ø±Ù! Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„.
```

**Ø§Ù„Ø­Ù„**: Ø¬Ø¯ÙˆÙ„ `user_decisions` ÙŠØ³Ø¬Ù„ ÙƒÙ„ Ù‚Ø±Ø§Ø±.

---

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 4: Current Selection Ù…Ø¹Ù‚Ø¯

```
Ù„Ø¹Ø±Ø¶ "Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ" Ù†Ø­ØªØ§Ø¬:
  1. Check if supplier_id exists
  2. Fetch official_name from suppliers
  3. Compare with raw_supplier_name
  4. Check if from learning or dictionary
  5. Determine badge text
  
5 Ø®Ø·ÙˆØ§Øª Ù„Ù…Ø¬Ø±Ø¯ badge!
```

**Ø§Ù„Ø­Ù„**: Ø­Ù‚Ù„ `decision_source` ÙŠØ®Ø²Ù‘Ù† Ø§Ù„Ù…ØµØ¯Ø± Ù…Ø¨Ø§Ø´Ø±Ø©.

---

## âœ… Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­ (After)

### Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  [Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ]                              â”‚
â”‚                                                             â”‚
â”‚  + Ø¬Ø¯ÙˆÙ„ Ø¬Ø¯ÙŠØ¯: supplier_suggestions                         â”‚
â”‚    â””â”€ normalized_input (from Excel)                        â”‚
â”‚    â””â”€ supplier_id                                          â”‚
â”‚    â””â”€ display_name                                         â”‚
â”‚    â””â”€ source (dictionary/learning/alternatives/history)    â”‚
â”‚    â””â”€ fuzzy_score, source_weight, usage_count              â”‚
â”‚    â””â”€ total_score, star_rating                             â”‚
â”‚    â””â”€ = Cache Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©                          â”‚
â”‚                                                             â”‚
â”‚  + Ø¬Ø¯ÙˆÙ„ Ø¬Ø¯ÙŠØ¯: user_decisions                               â”‚
â”‚    â””â”€ record_id, session_id                                â”‚
â”‚    â””â”€ raw_name, normalized_name                            â”‚
â”‚    â””â”€ chosen_supplier_id, chosen_display_name              â”‚
â”‚    â””â”€ decision_source (user_click/propagation/auto)        â”‚
â”‚    â””â”€ decided_at                                           â”‚
â”‚    â””â”€ = Ø³Ø¬Ù„ ÙƒÙ„ Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯:

#### Ø¹Ù†Ø¯ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù‚Ø±Ø§Ø±:
```
decision.php?record_id=123
        â”‚
        â–¼
SELECT * FROM supplier_suggestions
WHERE normalized_input = ?
ORDER BY total_score DESC
LIMIT 6
        â”‚
        â”œâ”€â”€ Found? â†’ Use cached suggestions âœ“
        â”‚
        â””â”€â”€ Not found? â†’ Generate once â†’ Save to cache
```

**Ø§Ù„ÙØ±Ù‚**: Query ÙˆØ§Ø­Ø¯ Ø¨Ø³ÙŠØ· Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 3 queries + matching!

#### Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸:
```
User clicks Save
        â”‚
        â”œâ”€â”€ 1. UPDATE imported_records
        â”‚
        â”œâ”€â”€ 2. INSERT INTO user_decisions (Ù…Ø¹ decision_source)
        â”‚
        â”œâ”€â”€ 3. UPDATE supplier_suggestions SET usage_count++
        â”‚       (ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ù€ cache)
        â”‚
        â””â”€â”€ 4. Propagate + INSERT user_decisions Ù„ÙƒÙ„ propagated
```

---

## ğŸ“‹ Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©

### Phase 1: Database (Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„)

**Ø§Ù„Ù…Ù„Ù**: `storage/migrations/add_suggestion_tables.sql`

```sql
-- 1. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…ÙØ®Ø²Ù‘Ù†Ø©
CREATE TABLE IF NOT EXISTS supplier_suggestions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    normalized_input VARCHAR(500) NOT NULL,
    supplier_id INTEGER NOT NULL,
    display_name VARCHAR(500) NOT NULL,
    source VARCHAR(50) NOT NULL,
    fuzzy_score REAL DEFAULT 0.0,
    source_weight INTEGER DEFAULT 0,
    usage_count INTEGER DEFAULT 0,
    total_score REAL DEFAULT 0.0,
    star_rating INTEGER DEFAULT 1,
    last_updated DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(normalized_input, supplier_id, source)
);

CREATE INDEX idx_suggestions_input ON supplier_suggestions(normalized_input);
CREATE INDEX idx_suggestions_score ON supplier_suggestions(total_score DESC);

-- 2. Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª
CREATE TABLE IF NOT EXISTS user_decisions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    record_id INTEGER NOT NULL,
    session_id INTEGER NOT NULL,
    raw_name VARCHAR(500) NOT NULL,
    normalized_name VARCHAR(500) NOT NULL,
    chosen_supplier_id INTEGER NOT NULL,
    chosen_display_name VARCHAR(500),
    decision_source VARCHAR(50) NOT NULL,
    decided_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (chosen_supplier_id) REFERENCES suppliers(id),
    FOREIGN KEY (record_id) REFERENCES imported_records(id)
);

CREATE INDEX idx_decisions_normalized ON user_decisions(normalized_name);
CREATE INDEX idx_decisions_supplier ON user_decisions(chosen_supplier_id);
CREATE INDEX idx_decisions_record ON user_decisions(record_id);
```

**Ø§Ù„Ø®Ø·ÙˆØ§Øª**:
1. [ ] Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù migration
2. [ ] ØªØ´ØºÙŠÙ„ SQL Ø¹Ù„Ù‰ database.sqlite
3. [ ] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„

---

### Phase 2: Repositories (Ø§Ù„ÙƒÙˆØ¯)

**Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©**:

#### 2.1. `app/Repositories/SupplierSuggestionRepository.php`

```php
class SupplierSuggestionRepository {
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…Ù† Ø§Ù„Ù€ cache
    public function getSuggestions(string $normalizedInput, int $limit = 6): array;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù€ cache
    public function saveSuggestions(string $normalizedInput, array $suggestions): void;
    
    // ØªØ­Ø¯ÙŠØ« usage Ùˆ score
    public function incrementUsage(string $normalizedInput, int $supplierId): void;
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ scores
    public function recalculateScore(string $normalizedInput, int $supplierId): void;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ cache
    public function hasCachedSuggestions(string $normalizedInput): bool;
}
```

#### 2.2. `app/Repositories/UserDecisionRepository.php`

```php
class UserDecisionRepository {
    
    // ØªØ³Ø¬ÙŠÙ„ Ù‚Ø±Ø§Ø± Ø¬Ø¯ÙŠØ¯
    public function logDecision(
        int $recordId,
        int $sessionId,
        string $rawName,
        string $normalizedName,
        int $supplierId,
        string $displayName,
        string $source  // 'user_click', 'user_typed', 'propagation', 'auto_select'
    ): int;
    
    // Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù‚Ø±Ø§Ø± Ù„Ø³Ø¬Ù„ Ù…Ø¹ÙŠÙ†
    public function getLastDecision(int $recordId): ?array;
    
    // Ø¬Ù„Ø¨ Ø£ÙƒØ«Ø± Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ø®ØªÙŠØ§Ø±Ø§Ù‹ Ù„Ø§Ø³Ù… Ù…Ø¹ÙŠÙ†
    public function getMostChosenSuppliers(string $normalizedName, int $limit = 5): array;
}
```

**Ø§Ù„Ø®Ø·ÙˆØ§Øª**:
1. [ ] Ø¥Ù†Ø´Ø§Ø¡ `SupplierSuggestionRepository.php`
2. [ ] Ø¥Ù†Ø´Ø§Ø¡ `UserDecisionRepository.php`
3. [ ] Ø§Ø®ØªØ¨Ø§Ø± ÙƒÙ„ method

---

### Phase 3: decision.php (Ø§Ù„Ø¹Ø±Ø¶)

**Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª**:

```php
// Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù…Ø¹Ù‚Ø¯):
$supplierCandidates = $candidateService->supplierCandidates($rawName)['candidates'];
// + enrichment + scoring + sorting + ...

// Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¨Ø³ÙŠØ·):
$suggestionRepo = new SupplierSuggestionRepository();
$normalized = $normalizer->normalizeSupplierName($rawName);

if ($suggestionRepo->hasCachedSuggestions($normalized)) {
    $supplierCandidates = $suggestionRepo->getSuggestions($normalized);
} else {
    // Generate once and cache
    $candidates = $candidateService->generateAndScore($rawName);
    $suggestionRepo->saveSuggestions($normalized, $candidates);
    $supplierCandidates = $candidates;
}

// Current selection from decisions table
$decisionRepo = new UserDecisionRepository();
$lastDecision = $decisionRepo->getLastDecision($recordId);
$decisionSource = $lastDecision['decision_source'] ?? null;
```

**Ø§Ù„Ø®Ø·ÙˆØ§Øª**:
1. [ ] Ø¥Ø¶Ø§ÙØ© imports Ù„Ù„Ù€ repositories Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
2. [ ] ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€ candidates
3. [ ] ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù… Current Selection
4. [ ] Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶

---

### Phase 4: process_update.php (Ø§Ù„Ø­ÙØ¸)

**Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª**:

```php
// Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„:

// 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø±
$decisionRepo = new UserDecisionRepository();
$decisionRepo->logDecision(
    $recordId,
    $sessionId,
    $rawName,
    $normalizedName,
    $supplierId,
    $displayName,
    'user_click' // or 'user_typed'
);

// 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ cache
$suggestionRepo = new SupplierSuggestionRepository();
$suggestionRepo->incrementUsage($normalizedName, $supplierId);

// 3. Propagation Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„
$propagated = $records->propagateToSession($sessionId, $rawName, $supplierId);
foreach ($propagated as $propagatedRecordId) {
    $decisionRepo->logDecision(
        $propagatedRecordId,
        $sessionId,
        $rawName,
        $normalizedName,
        $supplierId,
        $displayName,
        'propagation'  // â† Ù†ÙˆØ¹ Ù…Ø®ØªÙ„Ù!
    );
}
```

**Ø§Ù„Ø®Ø·ÙˆØ§Øª**:
1. [ ] Ø¥Ø¶Ø§ÙØ© logging Ù„Ù„Ù‚Ø±Ø§Ø±Ø§Øª
2. [ ] Ø¥Ø¶Ø§ÙØ© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ cache
3. [ ] ØªØ¹Ø¯ÙŠÙ„ propagation Ù„ÙŠØ³Ø¬Ù„
4. [ ] Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸

---

### Phase 5: Migration & Cleanup

**Ø§Ù„Ø®Ø·ÙˆØ§Øª**:
1. [ ] Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª learning Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ suggestions
2. [ ] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† backward compatibility
3. [ ] Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª
4. [ ] ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù„Ø§Ø­Ù‚Ø§Ù‹)

---

## ğŸ”™ Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ±Ø§Ø¬Ø¹

### Ø¥Ø°Ø§ Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø©:

**Ø§Ù„Ù€ Tag Ù„Ù„ØªØ±Ø§Ø¬Ø¹**:
```bash
git checkout v3.0-pre-refactor
```

**Ø£Ùˆ Ù…Ù† Ø§Ù„Ù€ Branch**:
```bash
git log --oneline
git checkout b6f634b  # Ø¢Ø®Ø± commit Ù‚Ø¨Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
```

**Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¢Ù…Ù†**:
- ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ© **Ù„Ù† ØªÙØ­Ø°Ù**
- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… **Ù„Ù† ÙŠÙØ²Ø§Ù„** Ø­ØªÙ‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„
- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© **Ø¥Ø¶Ø§ÙÙŠØ©** ÙÙ‚Ø·

---

## âœ… Checklist Ø§Ù„ØªÙ†ÙÙŠØ°

- [ ] **Phase 1**: Database tables created
- [ ] **Phase 2**: Repositories implemented
- [ ] **Phase 3**: decision.php updated
- [ ] **Phase 4**: process_update.php updated
- [ ] **Phase 5**: Migration complete
- [ ] **Testing**: All scenarios verified
- [ ] **Cleanup**: Old code removed (optional)
