---
last_updated: 2025-12-13
version: 1.1
status: active
---

# 08 - تحليل الحالات الحرجة (Edge Cases Analysis)

## مقدمة
يوضح هذا المستند **نقاط الضعف المحتملة** في منطق المطابقة والتعلم الحالي، خاصة عند التعامل مع ملفات Excel من مصادر متعددة.

## 1. الحالات الحرجة في المطابقة

### 1.1 الموردون المتشابهون (Similar Suppliers)
**السيناريو**: موردان مختلفان بأسماء متقاربة جداً.
- **مثال**: "مؤسسة النور للتجارة" و "مؤسسة النور التجارية"
- **المشكلة**: الـ Fuzzy Match قد يعطي نسبة عالية (>0.90) لكليهما.
- **النتيجة**: النظام قد يقترح المورد الخطأ بثقة عالية.
- **الحل الحالي**: يظهر كلاهما كمرشحين قويين (Conflict Detection).
- **⚠️ نقطة الفشل**: إذا كان أحدهما محفوظاً كـ Alias والآخر لا، سيتم الاختيار التلقائي للمحفوظ حتى لو كان خاطئاً.

> [!NOTE]
> **قرار المستخدم (User Decision)**:
> هذا أمر طبيعي ومقصود. يجب أن يتم اقتراح أكثر من اسم خلال مراجعة السجل لتوفير الوقت على المستخدم. المراجعة البشرية لمثل هذه الحالة **مطلوبة** لتقارب الأسماء الشديد.

### 1.2 تغيير أسماء الموردين (Supplier Name Changes)
**السيناريو**: مورد غير اسمه الرسمي في السجل التجاري.
- **مثال**: "شركة الأمل" أصبحت "شركة الأمل القابضة"
- **المشكلة**: 
  - الملفات القديمة تحتوي الاسم القديم.
  - الملفات الجديدة تحتوي الاسم الجديد.
- **النتيجة**: النظام يعتبرهما موردين مختلفين.
- **⚠️ نقطة الفشل**: لا يوجد آلية لـ "دمج" الموردين أو "إعادة توجيه" Alias من مورد لآخر.

> [!NOTE]
> **قرار المستخدم (User Decision)**:
> هذا أمر **مقصود** للحفاظ على السجلات السابقة وتاريخها. يجب عدم تأثر السجلات الجديدة بقرارات تاريخية قديمة. يجب إمكانية العودة لسجل قديم ورؤيته كما عدله المستخدم سابقاً بدون المعلومات الجديدة.

### 1.3 الشركات التابعة (Subsidiaries)
**السيناريو**: "الشركة السعودية للكهرباء" و "الشركة السعودية للكهرباء - فرع الرياض"
- **المشكلة**: هل هما نفس المورد أم مختلفان؟
- **⚠️ نقطة الفشل**: القرار متروك للمستخدم في كل مرة. لا يوجد منطق "الشركة الأم".

> [!NOTE]
> **قرار المستخدم (User Decision)**:
> لا يجب وضع قرار موحد. يجب أن يبقى البرنامج **مرناً** في هذه الحالة ليختار المستخدم ما يريده من بين الأسماء أو إدخال جديد.

## 2. الحالات الحرجة في التعلم

### 2.1 التعلم من القرارات الخاطئة (Learning Mistakes)
**السيناريو**: المستخدم اختار مورداً خاطئاً بالخطأ.
- **النتيجة**: النظام حفظ الاسم كـ Alias للمورد الخطأ.
- **الحل الحالي**: ✅ **آلية الحظر (Blocking) موجودة**.

> [!IMPORTANT]
> **قرار المستخدم (User Decision)**:
> كتابة اسم مورد جديد للسجل الجديد **تكفي** لإصلاح نظام التعلم. عندما يختار المستخدم موردًا مختلفًا، يقوم النظام بحفظ `supplier_blocked` للمورد الخاطئ، مما يمنعه من الظهور مستقبلاً. المسار يتصحح تلقائياً دون الإخلال بتاريخ السجل القديم.

### 2.2 الأسماء المشتركة (Ambiguous Names)
**السيناريو**: اسم "مؤسسة الخليج" موجود لموردين مختلفين في مدن مختلفة.
- **المشكلة**: النظام حالياً **يسمح** بربط نفس الاسم بموردين.
- **النتيجة**: عند الاستيراد، يظهر كلاهما كمرشحين "قويين".
- **الحل الحالي**: التمييز يعتمد على ذاكرة المستخدم.

> [!NOTE]
> **قرار المستخدم (User Decision)**:
> هذا هو **الأفضل**. القرار والحقيقة الدائمة في هذه الحالة يجب أن تأتي من المستخدم فقط (Human-in-the-Loop).

## 3. الحالات الحرجة في أرقام الضمانات

### 3.1 رقم ضمان واحد في بنوك متعددة (Duplicate Guarantee Across Banks)
**السيناريو**: رقم الضمان "12345" موجود في "البنك الأهلي" و "بنك الرياض".
- **الحالة الحالية**: النظام يميز بـ `guarantee_number + raw_bank_name`.
- **✅ آمن**: لا يوجد تعارض.

> [!NOTE]
> **قرار المستخدم (User Decision)**:
> السيناريو غير واقعي أصلاً - الرقم لا يمكن أن يتكرر في بنكين مختلفين.

### 3.2 أخطاء كتابية في رقم الضمان (Typos in Guarantee Number)
**السيناريو**: رقم الضمان الصحيح "ABC123" كُتب في ملف آخر "ABC1З3" (حرف روسي بدلاً من 2).
- **المشكلة**: النظام يعتبرهما ضمانين مختلفين.

> [!NOTE]
> **قرار المستخدم (User Decision)**:
> سيناريو غير منطقي. الوضع الحالي لا يحتاج تعديل.

### 3.3 تجديد الضمان بنفس الرقم (Guarantee Renewal)
**الحالة الحالية**: ✅ **محلول** - النظام يسمح بالتكرار (History Mode).

> [!NOTE]
> **قرار المستخدم (User Decision)**:
> لا يجب أن يكون هناك تنبيه. القبول التلقائي مطلوب للتجديدات.

## 4. الحالات الحرجة في أسماء البنوك

### 4.1 البنوك بأسماء إنجليزية (English Bank Names)
**السيناريو**: ملف يحتوي "SNB" بدلاً من "البنك الأهلي السعودي".
- **الحالة الحالية**: ✅ النظام يدعم `short_code`.

> [!TIP]
> **توصية**: إضافة كل الرموز المفيدة في قاموس البنوك.

### 4.2 أخطاء كتابية في اسم البنك (Bank Name Typos)
**السيناريو**: "البنك الأهلي السعودي" كُتب "البنك الأهللي السعودي".
- **الحالة الحالية**: Fuzzy Match يتعامل معه إذا كانت النسبة > 0.95.

> [!NOTE]
> **قرار المستخدم (User Decision)**:
> أسماء البنوك واضحة ومعروفة وثابتة غالباً. الوضع الحالي كافٍ.

## 5. الحالات التي يعمل فيها النظام بكفاءة

✅ **ملفات من نفس المصدر**: النظام ممتاز في التعلم من الاتساق.
✅ **الأخطاء الإملائية البسيطة**: Levenshtein يتعامل معها.
✅ **التجديدات (Renewals)**: History Mode يحفظها.
✅ **البنوك القياسية**: Short Codes فعالة جداً.

## 6. التوصيات (بدون تعديل كود)

### للمستخدم:
1. **مراجعة دورية للـ Aliases**: تحقق من صفحة "القواميس" (عند توفرها) لحذف Aliases الخاطئة.
2. **توحيد المصادر**: محاولة توحيد صيغة كتابة الأسماء قبل الاستيراد.
3. **استخدام الرموز**: الاعتماد على Short Codes للبنوك بدلاً من الأسماء الكاملة.

### للنظام (مستقبلاً):
1. **Conflict Explanation**: عند ظهور مرشحين متقاربين، اعرض "سبب التشابه" (Same Alias? Similar Fuzzy?).
2. **Alias Management UI**: واجهة لعرض وحذف Aliases.
3. **Duplicate Warning**: تنبيه عند استيراد رقم ضمان موجود (حتى لو مسموح).
