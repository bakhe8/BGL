# ุณุฌู ุงูุชุบููุฑุงุช - ุชุซุจูุช ูุธุงู ุงูููุฑุฏูู v5.0

> **ุงูุชุงุฑูุฎ**: 2025-12-17  
> **ุงูููุน**: ุชุญุฏูุซ ุดุงูู ูููู  
> **ุงูุญุงูุฉ**: โ ููุชูู

---

## ๐ ููุฎุต ุชูููุฐู

ุชู ุฅุฌุฑุงุก ุชุญุฏูุซ ุดุงูู ููุธุงู ุฅุฏุงุฑุฉ ุงูููุฑุฏูู ูุชุถูู:
1. **ุชุจุณูุท ุงูุจููุฉ**: ูู 4 ุฌุฏุงูู ุฅูู 2 ุฌุฏูู ุฑุฆูุณู
2. **ุฎูุงุฑุฒููุฉ ุญุธุฑ ุฌุฏูุฏุฉ**: ุชุฏุฑูุฌูุฉ ุจุฏูุงู ูู ููุฑูุฉ
3. **ุฅุตูุงุญ bugs**: ุนุฏุฉ ูุดุงูู ุชู ุงูุชุดุงููุง ูุฅุตูุงุญูุง
4. **ุชูุธูู ุงูููุฏ**: ุฅุฒุงูุฉ ุงููููุงุช ูุงูุฌุฏุงูู ุงููุฏููุฉ

---

## ๐ง ุงูุชุบููุฑุงุช ุงูุชูุตูููุฉ

### 1. ุฎูุงุฑุฒููุฉ ุงูุญุธุฑ ุงูุชุฏุฑูุฌู (NEW)

**ุงููุดููุฉ ุงููุฏููุฉ:**
- ุญุธุฑ ูุงุญุฏ = ุฅุฎูุงุก ููุฑู ูุฏุงุฆู ููููุฑุฏ
- ูุง ููุฌุฏ ุชุณุงูุญ ูุน ุฃุฎุทุงุก ุงููุณุชุฎุฏู

**ุงูุญู ุงูุฌุฏูุฏ:**
```
effective_score = total_score - (block_count ร 50)
```

| ูุฑุงุช ุงูุญุธุฑ | ุงูุนููุจุฉ | ุงูุชุฃุซูุฑ |
|------------|---------|---------|
| 0 | 0 | ูุธูุฑ ุนุงุฏู |
| 1 | -50 | ูุธูุฑ (ูุฑุชุจุฉ ุฃูู) |
| 2 | -100 | ูุธูุฑ (ููุฎูุถ ุฌุฏุงู) |
| 3+ | -150+ | ูุฎุชูู |

**ุงููููุงุช ุงูููุนุฏููุฉ:**
- `SupplierSuggestionRepository.php` - ุฅุถุงูุฉ `incrementBlock()`, `getBlockedSupplierIds()`
- `DecisionController.php` - ุงุณุชุฎุฏุงู ุงูุญุธุฑ ุงูุชุฏุฑูุฌู
- `CandidateService.php` - ููุชุฑุฉ ุจุงุณุชุฎุฏุงู `$blockedIds`
- `MatchingService.php` - ููุณ ุงูููุทู

---

### 2. ุชุฑุญูู ุฌุฏูู ุงูุชุนูู

**ูุจู:**
```sql
supplier_aliases_learning (OLD)
โโโ original_supplier_name
โโโ normalized_supplier_name
โโโ linked_supplier_id
โโโ learning_status (supplier_alias / supplier_blocked)
โโโ usage_count
```

**ุจุนุฏ:**
```sql
supplier_suggestions (NEW)
โโโ normalized_input
โโโ supplier_id
โโโ display_name
โโโ source
โโโ fuzzy_score
โโโ source_weight
โโโ usage_count
โโโ block_count โ NEW
โโโ total_score
โโโ star_rating
```

**ุงูุนูููุฉ:**
1. ุชุฑุญูู 22 ุณุฌู ูู ุงูุฌุฏูู ุงููุฏูู
2. ุญุฐู ุฌุฏูู `supplier_aliases_learning`
3. ุญุฐู ููู `SupplierLearningRepository.php`

---

### 3. ุฅุตูุงุญ Bugs

#### Bug 1: `supplier_display_name` ูุง ููุญูุธ
**ุงููุดููุฉ:** ุงูููุฏ ูุงู ููุญุต `$update['raw_supplier_name']` ุงูุฐู ูุง ููุฑุณูู ุงูู frontend.

**ุงูุฅุตูุงุญ:**
```php
// ูุจู
if (!empty($update['supplier_id']) && !empty($update['raw_supplier_name'])) {

// ุจุนุฏ
$rawSupplierName = $record->rawSupplierName ?? $update['raw_supplier_name'] ?? null;
if (!empty($update['supplier_id']) && !empty($rawSupplierName)) {
```

**ุงูููู:** `DecisionController.php`

---

#### Bug 2: Star Rating Threshold ุบูุฑ ูุชูุญุฏุฉ
**ุงููุดููุฉ:** 
- `SupplierSuggestionRepository`: >=220 = 3โ, >=160 = 2โ
- `CandidateService`: >=200 = 3โ, >=120 = 2โ

**ุงูุฅุตูุงุญ:** ุชูุญูุฏ ุฅูู (200/120) ูู ูู ุงููููุงุช.

---

#### Bug 3: Cache Invalidation ููููุฏ
**ุงููุดููุฉ:** ุชุบููุฑ ุงุณู ุงูููุฑุฏ ูู ุงูุฅุนุฏุงุฏุงุช ูุง ููุญุฏูุซ ุงููุงุด.

**ุงูุฅุตูุงุญ:**
```php
// DictionaryController::updateSupplier()
if ($nameChanged) {
    $db->exec("UPDATE supplier_suggestions SET display_name = ? WHERE supplier_id = ?");
}
```

---

#### Bug 4: Undefined Variable `$supplierLearning`
**ุงููุดููุฉ:** ุธููุฑ ุฎุทุฃ ูู `decision.php` ุจุณุจุจ ุงุณุชุฎุฏุงู ูุชุบูุฑ ูุดูุฑ ูู Repository ูุญุฐูู.

**ุงูุฅุตูุงุญ:** ุฅุฒุงูุฉ ุงูุงุนุชูุงุฏ ุนูู `SupplierLearningRepository` ุงููุฏูู ูุงุณุชุฎุฏุงู `UserDecisionRepository` ูุชุญุฏูุฏ ูุตุฏุฑ ุงููุฑุงุฑ.

---

#### Bug 5: ุฒุฑ "ุฅุถุงูุฉ ูููุฑุฏ ุฌุฏูุฏ" ูุธูุฑ ูููุฑุฏูู ููุฌูุฏูู
**ุงููุดููุฉ:** ุงูุฒุฑ ูุธูุฑ ุญุชู ูู ูุงู ุงูููุฑุฏ ููุฌูุฏุงู ูู ุงููุงุฆูุฉ ุฅุฐุง ูุงู ููุงู ุงุฎุชูุงู ุจุณูุท (ูุณุงูุงุชุ ุฃุญุฑู ูุจูุฑุฉ/ุตุบูุฑุฉ).

**ุงูุฅุตูุงุญ:** ููู ููุทู ุงูุชูุญูุฏ ุงูููุงุณู (`Normalizer logic`) ูู ุงูุณูุฑูุฑ ุฅูู ุงูุฌุงูุงุณูุฑุจุช ูู `decision.php` ูุถูุงู ุชุทุงุจู ุงูุชุญูู ูู ุงููุงุฌูุฉ ูุน ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

---

### 4. ุชูุธูู ุงูููุฏ

**ุงููููุงุช ุงููุญุฐููุฉ:**
- `app/Repositories/SupplierLearningRepository.php`
- `analyze_zimmo.php`
- `temp_reference/` folder
- `scripts/` temp scripts

**ุงูุชุบููุฑุงุช ูู ุงููููุงุช:**
- ุฅุฒุงูุฉ imports ุบูุฑ ูุณุชุฎุฏูุฉ
- ุฅุฒุงูุฉ properties ุบูุฑ ูุณุชุฎุฏูุฉ
- ุชุญุฏูุซ ุงูุชุนูููุงุช

---

## ๐ ุงูุฌุฏุงูู ุงูููุงุฆูุฉ ููููุฑุฏูู

```
โ supplier_suggestions      โ ุงูุฌุฏูู ุงูุฑุฆูุณู (ุชุนูู + ุญุธุฑ + ูุงุด)
โ user_decisions           โ ุณุฌู ุงููุฑุงุฑุงุช
โ suppliers                โ ุงููุงููุณ ุงูุฑุณูู
โ supplier_alternative_names โ ุงูุฃุณูุงุก ุงูุจุฏููุฉ ุงููุฏููุฉ
โ imported_records         โ ุงูุณุฌูุงุช ุงููุณุชูุฑุฏุฉ

โ supplier_aliases_learning โ ูุญุฐูู (ุจูุงูุงุช ููุฑุญููุฉ)
```

---

## ๐ ุงููููุงุช ุงูููุนุฏููุฉ

### Repositories
| ุงูููู | ุงูุชุบููุฑุงุช |
|-------|-----------|
| `SupplierSuggestionRepository.php` | ุฅุถุงูุฉ `block_count`, `effective_score`, ุทุฑู ุงูุญุธุฑ |
| `UserDecisionRepository.php` | ูู ุชุชุบูุฑ |

### Services
| ุงูููู | ุงูุชุบููุฑุงุช |
|-------|-----------|
| `CandidateService.php` | Cache-Firstุ ุฅุฒุงูุฉ fallback ููุฌุฏูู ุงููุฏููุ ุงุณุชุฎุฏุงู `$blockedIds` |
| `MatchingService.php` | ุงุณุชุฎุฏุงู `supplier_suggestions` ุจุฏูุงู ูู ุงูุฌุฏูู ุงููุฏูู |

### Controllers
| ุงูููู | ุงูุชุบููุฑุงุช |
|-------|-----------|
| `DecisionController.php` | ุฅุตูุงุญ `raw_supplier_name` bugุ ุงุณุชุฎุฏุงู ุงูุญุธุฑ ุงูุชุฏุฑูุฌู |
| `DictionaryController.php` | ุฅุถุงูุฉ Cache Invalidationุ ุชุจุณูุท ุฅุถุงูุฉ ููุฑุฏ ุฌุฏูุฏ |

### Frontend
| ุงูููู | ุงูุชุบููุฑุงุช |
|-------|-----------|
| `www/decision.php` | ุฅุฒุงูุฉ imports ุบูุฑ ูุณุชุฎุฏูุฉ |

---

## โ ุงูุงุฎุชุจุงุฑุงุช

- [x] Syntax check ูุฌููุน ุงููููุงุช
- [x] ุชุฑุญูู ุงูุจูุงูุงุช ุจูุฌุงุญ
- [x] ุญุฐู ุงูุฌุฏุงูู/ุงููููุงุช ุงููุฏููุฉ
- [ ] ุงุฎุชุจุงุฑ ูุชุตูุญ ุดุงูู (ูุทููุจ)

---

## ๐ฎ ุงูุนูู ุงููุณุชูุจูู

1. **ุงุฎุชุจุงุฑ ูุชุตูุญ ุดุงูู** ููุชุฃูุฏ ูู ุนูู ูู ุงูุณููุงุฑูููุงุช
2. **ูุฑุงูุจุฉ ุงูุฃุฏุงุก** ููุชุฃูุฏ ูู ุณุฑุนุฉ ุงููุงุด
3. **(ุงุฎุชูุงุฑู)** ูุธุงู ูุดุงุจู ููุจููู ุฅุฐุง ูุฒู ุงูุฃูุฑ

---

## ๐ ุงููุซุงุฆู ุงูููุญุฏูุซุฉ

- `docs/09-Supplier-System-Refactoring.md` - ุฅุนุงุฏุฉ ูุชุงุจุฉ ูุงููุฉ
- ุชุนูููุงุช ุงููููุงุช ุงูุฑุฆูุณูุฉ
