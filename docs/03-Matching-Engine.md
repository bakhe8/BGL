---
last_updated: 2025-12-13
version: 2.0
status: active
---

# 03 - محرك المطابقة (Matching Engine)

يعد محرك المطابقة (Matching Engine) القلب النابض للنظام، حيث يقوم بربط البيانات المستوردة من ملفات Excel مع السجلات المعتمدة في قاعدة البيانات (الموردين والبنوك).

## 1. فلسفة النظام (Core Philosophy)

### المبدأ الأساسي
```
النظام لا يخترع بيانات غير موجودة.
إذا لم يوجد تطابق كافٍ، تبقى الخانة فارغة.
```

### لماذا هذا التصميم؟
| البديل | المشكلة |
|--------|---------|
| إظهار أي نتيجة | اقتراحات عشوائية تُضلل المستخدم وتدخل بيانات خاطئة |
| إجبار المستخدم على الاختيار | تجربة مستخدم سيئة وتأخير في العمل |
| خفض العتبات تلقائياً | فقدان الدقة وقبول نتائج غير صحيحة |

**القرار:** الخانة الفارغة تعني "لا يوجد تطابق مقبول" وهذا سلوك **صحيح ومقصود**.

---

## 2. آلية المطابقة (Matching Mechanism)

يتم حساب درجة تشابه (Score) بين النص المدخل في Excel وبين قاعدة البيانات (0.0 إلى 1.0).

### العوامل المؤثرة (Scoring Factors):
1. **Official Match (الاسم الرسمي)**: تطابق تام مع الاسم المسجل. (الوزن الافتراضي: 1.0)
2. **Alias Match (اسم بديل)**: تطابق مع اسم "شهر" أو "بديل" تم حفظه سابقاً.
   - مؤكد يدوياً: وزن 0.95
   - تعلم آلي: وزن 0.75
3. **Fuzzy Match (مطابقة تقريبية)**: استخدام خوارزمية Levenshtein لتجاوز الأخطاء الإملائية. (الوزن: 0.80)

### خوارزميات التشابه (Algorithms)
النظام يستخدم مزيجاً من الخوارزميات، ويأخذ النتيجة الأعلى:
1. `Exact Match`: تطابق تام (1.0).
2. `Starts With`: أحدهما يبدأ بالآخر (0.85).
3. `Contains`: أحدهما يحتوي الآخر (0.75).
4. `Levenshtein`: مسافة التعديل (Fuzzy).
5. `Token Jaccard`: تشابه الكلمات المفردة.

---

## 3. الفرق بين المورد والبنك (Suppliers vs Banks)

> [!CAUTION]
> **مفهوم جوهري**: المنطق البرمجي للموردين يختلف جذرياً عن البنوك.

| الميزة | المورد (Supplier) | البنك (Bank) |
| :--- | :--- | :--- |
| **مصدر المطابقة** | الاسم الرسمي + جدول الأسماء البديلة (`aliases`) | الاسم الرسمي (عربي/إنجليزي) + الرمز المختصر (`short_code`) |
| **اللغة** | عربي بشكل أساسي (إلا إذا تم تعليم اسم إنجليزي كبديل) | ثنائي اللغة (Native Support) |
| **الرموز** | لا يوجد | يدعم الرموز البنكية (مثل SNB, SAB) |
| **التعلم** | يعتمد كلياً على إضافة Aliases | يعتمد على Aliases فقط في الحالات النادرة |

---

## 4. حالات السجل (Record Status)

بعد عملية المطابقة، تظهر السجلات في النظام بإحدى الحالات التالية:

- **جاهز (Ready)**:
  - تم العثور على مورد وبنك بدرجة ثقة > 0.90 (Match Auto Threshold).
  - لا يوجد تعارض (Conflict) مع نتائج أخرى قريبة.
- **يحتاج مراجعة (Needs Review)**:
  - الدرجة أقل من 0.90.
  - أو يوجد أكثر من نتيجة قوية متقاربة جداً (Conflict).
  - أو أحد الطرفين (المورد أو البنك) غير معروف (فارغ).

---

## 5. الاعتماد التلقائي (Auto-Accept)

النظام يمتلك **آلية ذكية** لقبول السجلات تلقائياً عند توفر الشروط التالية:

### الشروط
- درجة المطابقة **≥ 0.95**.
- المصدر موثوق: `official`, `override`, أو `alternative` (ليس fuzzy ضعيف).
- **لا يوجد تعارض** مع نتائج أخرى (الفرق بين الأول والثاني ≥ 0.05).

### ماذا يحدث؟
1. تتغير حالة السجل إلى **"جاهز"** تلقائياً.
2. يظهر **badge أخضر "تلقائي ✓"**.
3. يتم حفظ القرار كـ `auto` في قاعدة البيانات.

---

## 6. التعلم (System Learning)

كيف يصبح النظام أذكى؟

1. **إضافة مورد جديد**: عند إضافة مورد غير موجود، يتعرف عليه النظام فوراً في المرات القادمة (تطابق 100%).
2. **الأسماء البديلة (Aliases)**: عند ربط اسم غريب ("شركة أرامكو") مع مورد رسمي ("شركة الزيت العربية السعودية")، يحفظ النظام هذا الربط.
3. **التعلم التلقائي**: تخزين اختيارات المستخدم في جدول `supplier_learning` لتحسين الاقتراحات المستقبلية.

---

## 7. أدوات للمطورين (Developer Tools)

- **سكربت التشخيص**: `php debug_supplier_match.php` لاختبار كيف يفهم النظام نصاً معيناً.
- **API المباشر**: `/api/records/{id}/candidates` لفحص استجابة الخادم الخام.

---

## 8. التحسينات المستقبلية (Future Roadmap)

### تجاوز قواعد التطبيع (Normalization Override)
*   **الحالة الحالية:** النظام يعتبر الأسماء متطابقة إذا كانت الاختلافات فقط في الرموز (`.` , `-`) أو الكلمات الشائعة (`CO`, `LTD`).
    *   مثال: `Supplier CO.` = `Supplier CO`
    *   النتيجة: لا يمكن إضافة النسخة الأخرى كمورد جديد (خطأ 409 Conflict).
*   **التحسين المقترح:** إضافة خيار "إجبار الإضافة" (Force Add) أو خيارات متقدمة في الإعدادات تسمح للمستخدم بتعطيل تجاهل الكلمات الشائعة (Strict Mode) في حال الرغبة في تمييز هذه الفروقات الدقيقة.


