<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dictionary</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <header class="app-header">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="font-semibold text-lg">Dictionary Management</div>
      <nav class="nav">
        <a href="/import">Import</a>
        <a href="/records">Records</a>
        <a href="/review">Review Panel</a>
        <a href="/dictionary" class="active">Dictionary</a>
        <a href="/settings">Settings</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8 space-y-6">
    <section class="card">
      <div class="flex items-center justify-between mb-3">
        <h1 class="card-title">الموردون</h1>
        <div class="flex gap-2">
          <input type="search" id="sSearch" class="input" placeholder="بحث (normalized)">
          <button id="sSearchBtn" class="btn btn-secondary">بحث</button>
        </div>
      </div>
      <form id="supplierForm" class="grid-2 mb-4">
        <div>
          <label class="label">اسم المورد الرسمي</label>
          <input type="text" id="sName" class="input">
        </div>
        <div>
          <label class="label">اسم العرض (اختياري)</label>
          <input type="text" id="sDisplay" class="input">
        </div>
        <div class="flex items-center gap-3">
          <button type="submit" class="btn btn-primary">حفظ</button>
          <span id="sMsg" class="muted text-sm"></span>
        </div>
      </form>
      <div class="table-wrap">
        <table class="table" id="suppliersTable">
          <thead>
            <tr>
              <th>#</th>
              <th>الاسم</th>
              <th>normalized</th>
              <th>بدائل</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="suppliersBody">
            <tr><td colspan="5" class="muted">لا يوجد بيانات.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="flex items-center justify-between mb-3">
        <h1 class="card-title">البنوك</h1>
        <div class="flex gap-2">
          <input type="search" id="bSearch" class="input" placeholder="بحث (normalized)">
          <button id="bSearchBtn" class="btn btn-secondary">بحث</button>
        </div>
      </div>
      <form id="bankForm" class="grid-2 mb-4">
        <div>
          <label class="label">اسم البنك الرسمي</label>
          <input type="text" id="bName" class="input">
        </div>
        <div>
          <label class="label">اسم العرض (اختياري)</label>
          <input type="text" id="bDisplay" class="input">
        </div>
        <div class="flex items-center gap-3">
          <button type="submit" class="btn btn-primary">حفظ</button>
          <span id="bMsg" class="muted text-sm"></span>
        </div>
      </form>
      <div class="table-wrap">
        <table class="table" id="banksTable">
          <thead>
            <tr>
              <th>#</th>
              <th>الاسم</th>
              <th>normalized</th>
              <th>بدائل</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="banksBody">
            <tr><td colspan="5" class="muted">لا يوجد بيانات.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2 class="section-title">الأسماء البديلة</h2>
      <div class="grid-2">
        <div class="card" style="padding:16px;">
          <div class="grid-2 gap-2">
            <input type="number" id="altSupplierId" class="input" placeholder="Supplier ID">
            <input type="text" id="altRaw" class="input" placeholder="اسم بديل">
          </div>
          <div class="flex items-center gap-3 mt-2">
            <button id="altAdd" class="btn btn-secondary">إضافة</button>
            <span id="altMsg" class="muted text-sm"></span>
          </div>
          <div id="altList" class="table-wrap" style="margin-top:10px;"></div>
        </div>
        <div class="card" style="padding:16px;">
          <div class="grid-2 gap-2">
            <input type="number" id="altBankId" class="input" placeholder="Bank ID">
            <input type="text" id="altBankRaw" class="input" placeholder="اسم بديل للبنك">
          </div>
          <div class="flex items-center gap-3 mt-2">
            <button id="altBankAdd" class="btn btn-secondary">إضافة</button>
            <span id="altBankMsg" class="muted text-sm"></span>
          </div>
          <div id="altBankList" class="table-wrap" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const suppliersBody = document.getElementById('suppliersBody');
    const banksBody = document.getElementById('banksBody');
    const sForm = document.getElementById('supplierForm');
    const bForm = document.getElementById('bankForm');
    const sMsg = document.getElementById('sMsg');
    const bMsg = document.getElementById('bMsg');

    async function loadSuppliers() {
      const q = document.getElementById('sSearch').value || '';
      const res = await fetch('/api/dictionary/suppliers' + (q ? `?q=${encodeURIComponent(q)}` : ''));
      const json = await res.json();
      if (!json.success) { suppliersBody.innerHTML = '<tr><td colspan="5" class="muted">تعذر التحميل</td></tr>'; return; }
      const rows = json.data || [];
      if (!rows.length) { suppliersBody.innerHTML = '<tr><td colspan="5" class="muted">لا يوجد بيانات.</td></tr>'; return; }
      suppliersBody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.id}</td>
          <td>${r.official_name}</td>
          <td class="muted">${r.normalized_name}</td>
          <td class="muted">${r.alternatives_count ?? 0}</td>
          <td>
            <button class="btn btn-ghost" onclick="fillSupplier(${r.id}, '${r.official_name.replace(/'/g, \"\\\\'\")}', '${(r.display_name||'').replace(/'/g, \"\\\\'\")}')">تعديل</button>
            <button class="btn btn-ghost" onclick="deleteSupplier(${r.id})">حذف</button>
            <button class="btn btn-secondary" onclick="showAltList(${r.id}, 'supplier')">عرض البدائل</button>
          </td>
        </tr>`).join('');
    }

    async function loadBanks() {
      const q = document.getElementById('bSearch').value || '';
      const res = await fetch('/api/dictionary/banks' + (q ? `?q=${encodeURIComponent(q)}` : ''));
      const json = await res.json();
      if (!json.success) { banksBody.innerHTML = '<tr><td colspan="5" class="muted">تعذر التحميل</td></tr>'; return; }
      const rows = json.data || [];
      if (!rows.length) { banksBody.innerHTML = '<tr><td colspan="5" class="muted">لا يوجد بيانات.</td></tr>'; return; }
      banksBody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.id}</td>
          <td>${r.official_name}</td>
          <td class="muted">${r.normalized_name}</td>
          <td class="muted">${r.alternatives_count ?? 0}</td>
          <td>
            <button class="btn btn-ghost" onclick="fillBank(${r.id}, '${r.official_name.replace(/'/g, \"\\\\'\")}', '${(r.display_name||'').replace(/'/g, \"\\\\'\")}')">تعديل</button>
            <button class="btn btn-ghost" onclick="deleteBank(${r.id})">حذف</button>
            <button class="btn btn-secondary" onclick="showAltList(${r.id}, 'bank')">عرض البدائل</button>
          </td>
        </tr>`).join('');
    }

    sForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = sForm.dataset.editId;
      const url = id ? `/api/dictionary/suppliers/${id}` : '/api/dictionary/suppliers';
      const payload = {
        official_name: document.getElementById('sName').value,
        display_name: document.getElementById('sDisplay').value,
      };
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const json = await res.json();
      if (!json.success) { sMsg.textContent = json.message || 'تعذر الحفظ'; sMsg.className='alert alert-error'; return; }
      sMsg.textContent = 'تم الحفظ'; sMsg.className='alert alert-success';
      sForm.dataset.editId = '';
      document.getElementById('sName').value = '';
      document.getElementById('sDisplay').value = '';
      loadSuppliers();
    });

    bForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = bForm.dataset.editId;
      const url = id ? `/api/dictionary/banks/${id}` : '/api/dictionary/banks';
      const payload = {
        official_name: document.getElementById('bName').value,
        display_name: document.getElementById('bDisplay').value,
      };
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const json = await res.json();
      if (!json.success) { bMsg.textContent = json.message || 'تعذر الحفظ'; bMsg.className='alert alert-error'; return; }
      bMsg.textContent = 'تم الحفظ'; bMsg.className='alert alert-success';
      bForm.dataset.editId = '';
      document.getElementById('bName').value = '';
      document.getElementById('bDisplay').value = '';
      loadBanks();
    });

    window.fillSupplier = (id, name, display) => {
      document.getElementById('sName').value = name;
      document.getElementById('sDisplay').value = display;
      sForm.dataset.editId = id;
      sMsg.textContent = `تعديل مورد #${id}`;
      sMsg.className = 'muted text-sm';
    };
    window.fillBank = (id, name, display) => {
      document.getElementById('bName').value = name;
      document.getElementById('bDisplay').value = display;
      bForm.dataset.editId = id;
      bMsg.textContent = `تعديل بنك #${id}`;
      bMsg.className = 'muted text-sm';
    };

    window.deleteSupplier = async (id) => { await fetch(`/api/dictionary/suppliers/${id}`, { method:'DELETE' }); loadSuppliers(); };
    window.deleteBank = async (id) => { await fetch(`/api/dictionary/banks/${id}`, { method:'DELETE' }); loadBanks(); };
    document.getElementById('sSearchBtn').addEventListener('click', loadSuppliers);
    document.getElementById('bSearchBtn').addEventListener('click', loadBanks);

    async function loadAlternatives() {
      const sid = document.getElementById('altSupplierId').value;
      const box = document.getElementById('altList');
      if (!sid) { box.innerHTML = '<div class="muted">أدخل Supplier ID للعرض</div>'; return; }
      const res = await fetch(`/api/dictionary/suppliers/${sid}/alternatives`);
      const json = await res.json();
      if (!json.success) { box.innerHTML = '<div class="muted">تعذر التحميل</div>'; return; }
      const rows = json.data || [];
      box.innerHTML = rows.length ? `
        <table class="table"><thead><tr><th>#</th><th>الاسم الخام</th><th>normalized</th><th>إجراءات</th></tr></thead>
        <tbody>
          ${rows.map(r => `<tr><td>${r.id}</td><td>${r.raw_name}</td><td class="muted">${r.normalized_raw_name}</td><td><button class="btn btn-ghost" onclick="deleteAlt(${r.id})">حذف</button></td></tr>`).join('')}
        </tbody></table>
      ` : '<div class="muted">لا توجد أسماء بديلة.</div>';
    }
    document.getElementById('altSupplierId').addEventListener('change', loadAlternatives);
    document.getElementById('altAdd').addEventListener('click', async () => {
      const sid = document.getElementById('altSupplierId').value;
      const raw = document.getElementById('altRaw').value;
      const msg = document.getElementById('altMsg');
      if (!sid || !raw) { msg.textContent='Supplier ID والاسم البديل مطلوبان'; msg.className='alert alert-error'; return; }
      const res = await fetch(`/api/dictionary/suppliers/${sid}/alternatives`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({raw_name: raw})});
      const json = await res.json();
      if (!json.success) { msg.textContent = json.message || 'تعذر الإضافة'; msg.className='alert alert-error'; return; }
      msg.textContent='تمت الإضافة'; msg.className='alert alert-success';
      document.getElementById('altRaw').value='';
      loadAlternatives();
    });
    window.deleteAlt = async (id) => { await fetch(`/api/dictionary/alternatives/${id}`, { method:'DELETE' }); loadAlternatives(); };

    async function loadBankAlternatives() {
      const bid = document.getElementById('altBankId').value;
      const box = document.getElementById('altBankList');
      if (!bid) { box.innerHTML = '<div class="muted">أدخل Bank ID للعرض</div>'; return; }
      const res = await fetch(`/api/dictionary/banks/${bid}/alternatives`);
      const json = await res.json();
      if (!json.success) { box.innerHTML = '<div class="muted">تعذر التحميل</div>'; return; }
      const rows = json.data || [];
      box.innerHTML = rows.length ? `
        <table class="table"><thead><tr><th>#</th><th>الاسم الخام</th><th>normalized</th><th>إجراءات</th></tr></thead>
        <tbody>
          ${rows.map(r => `<tr><td>${r.id}</td><td>${r.raw_name}</td><td class="muted">${r.normalized_raw_name}</td><td><button class="btn btn-ghost" onclick="deleteBankAlt(${r.id})">حذف</button></td></tr>`).join('')}
        </tbody></table>
      ` : '<div class="muted">لا توجد أسماء بديلة.</div>';
    }
    document.getElementById('altBankId').addEventListener('change', loadBankAlternatives);
    document.getElementById('altBankAdd').addEventListener('click', async () => {
      const bid = document.getElementById('altBankId').value;
      const raw = document.getElementById('altBankRaw').value;
      const msg = document.getElementById('altBankMsg');
      if (!bid || !raw) { msg.textContent='Bank ID والاسم البديل مطلوبان'; msg.className='alert alert-error'; return; }
      const res = await fetch(`/api/dictionary/banks/${bid}/alternatives`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({raw_name: raw})});
      const json = await res.json();
      if (!json.success) { msg.textContent = json.message || 'تعذر الإضافة'; msg.className='alert alert-error'; return; }
      msg.textContent='تمت الإضافة'; msg.className='alert alert-success';
      document.getElementById('altBankRaw').value='';
      loadBankAlternatives();
    });
    window.deleteBankAlt = async (id) => { await fetch(`/api/dictionary/bank-alternatives/${id}`, { method:'DELETE' }); loadBankAlternatives(); };
    window.showAltList = (id, type) => {
      if (type === 'supplier') { document.getElementById('altSupplierId').value = id; loadAlternatives(); }
      else { document.getElementById('altBankId').value = id; loadBankAlternatives(); }
      window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
    };

    loadSuppliers();
    loadBanks();
  </script>
</body>
</html>
