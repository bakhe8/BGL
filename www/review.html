<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة المراجعة</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <header class="app-header">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="font-semibold text-lg">لوحة المراجعة</div>
      <nav class="nav">
        <a href="/import">Import</a>
        <a href="/records">Records</a>
        <a href="/review" class="active">Review Panel</a>
        <a href="/dictionary">Dictionary</a>
        <a href="/settings">Settings</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8 space-y-6">
    <section class="card">
      <div class="flex items-center justify-between mb-3">
        <h1 class="card-title">السجلات قيد المراجعة</h1>
        <div class="flex gap-2">
          <button id="refresh" class="btn btn-secondary">تحديث</button>
          <button class="btn btn-ghost" disabled>Filter (لاحقًا)</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>المورد</th>
              <th>البنك</th>
              <th>المبلغ</th>
              <th>تاريخ الانتهاء</th>
              <th>الحالة</th>
            </tr>
          </thead>
          <tbody id="recordsTable">
            <tr><td colspan="6" class="muted">لا يوجد سجلات.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section id="detailSection" class="card" style="display:none;">
      <div class="flex items-center justify-between mb-4">
        <h2 class="section-title">تفاصيل السجل</h2>
        <div id="detailMeta" class="muted text-sm"></div>
      </div>

      <div class="card" style="background:#f8fafc; padding:16px; margin-bottom:16px;">
        <h3 class="card-subtitle" style="margin-bottom:10px;">التعارضات</h3>
        <div id="conflicts" class="conflict-item" style="display:none;"></div>
      </div>

      <div class="grid-2 mb-3">
        <div class="card" style="padding:16px;">
          <h3 class="card-subtitle">المورد</h3>
          <div class="muted text-sm">الأصلي</div>
          <div id="dSupplier" class="font-semibold"></div>
          <div class="muted text-sm">المطبع</div>
          <div id="dSupplierNorm"></div>
          <div class="muted text-sm">المقترح</div>
          <div id="dSupplierSuggested">—</div>
        </div>
        <div class="card" style="padding:16px;">
          <h3 class="card-subtitle">البنك</h3>
          <div class="muted text-sm">الأصلي</div>
          <div id="dBank" class="font-semibold"></div>
          <div class="muted text-sm">المطبع</div>
          <div id="dBankNorm"></div>
          <div class="muted text-sm">المقترح</div>
          <div id="dBankSuggested">—</div>
        </div>
      </div>

      <div class="grid-2 mb-3">
        <div>
          <h3 class="card-subtitle">بيانات الضمان</h3>
          <div class="grid-2">
            <div><span class="label">رقم الضمان</span><div id="dGuarantee"></div></div>
            <div><span class="label">المبلغ</span><div id="dAmount"></div></div>
            <div><span class="label">تاريخ الإصدار</span><div id="dIssue"></div></div>
            <div><span class="label">تاريخ الانتهاء</span><div id="dExpiry"></div></div>
          </div>
        </div>
        <div>
          <h3 class="card-subtitle">معلومات الاستيراد</h3>
          <div class="grid-2">
            <div><span class="label">جلسة الاستيراد</span><div id="dSession"></div></div>
            <div><span class="label">تاريخ الإدخال</span><div id="dCreated"></div></div>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <h3 class="section-title">اقتراحات المورد</h3>
          <div id="supplierSuggestions"></div>
        </div>
        <div>
          <h3 class="section-title">اقتراحات البنك</h3>
          <div id="bankSuggestions"></div>
        </div>
      </div>

      <hr style="margin:16px 0;border-color:#e2e8f0;">

      <form id="decisionForm" class="grid-2">
        <div>
          <label class="label">اسم المورد (تعديل اختياري)</label>
          <input type="text" id="fSupplier" class="input" />
        </div>
        <div>
          <label class="label">اسم البنك (تعديل اختياري)</label>
          <input type="text" id="fBank" class="input" />
        </div>
        <div>
          <label class="label">المبلغ</label>
          <input type="text" id="fAmount" class="input" />
        </div>
        <div>
          <label class="label">رقم الضمان</label>
          <input type="text" id="fGuarantee" class="input" />
        </div>
        <div>
          <label class="label">تاريخ الإصدار</label>
          <input type="text" id="fIssue" class="input" placeholder="YYYY-MM-DD" />
        </div>
        <div>
          <label class="label">تاريخ الانتهاء</label>
          <input type="text" id="fExpiry" class="input" placeholder="YYYY-MM-DD" />
        </div>
        <div>
          <label class="label">الحالة</label>
          <select id="fStatus" class="input">
            <option value="needs_review">Needs Review</option>
            <option value="ready">Ready</option>
          </select>
        </div>
      </form>
      <div class="mt-4 flex items-center gap-3">
        <button id="saveDecision" class="btn btn-primary">حفظ القرار</button>
        <div id="decisionMsg" class="muted text-sm"></div>
      </div>
    </section>
  </main>

  <script>
    const tableBody = document.getElementById('recordsTable');
    const refreshBtn = document.getElementById('refresh');
    const detailSection = document.getElementById('detailSection');
    const detailMeta = document.getElementById('detailMeta');
    const decisionMsg = document.getElementById('decisionMsg');
    let records = [];
    let selected = null;

    async function loadRecords() {
      tableBody.innerHTML = '<tr><td colspan="6" class="muted">جارٍ التحميل...</td></tr>';
      const res = await fetch('/api/records');
      const json = await res.json();
      if (!json.success) {
        tableBody.innerHTML = '<tr><td colspan="6" class="muted">تعذر تحميل السجلات</td></tr>';
        return;
      }
      records = (json.data || []);
      renderTable();
      if (records.length) {
        showDetail(records[0]);
      } else {
        detailSection.style.display = 'none';
      }
    }

    function renderTable() {
      if (!records.length) {
        tableBody.innerHTML = '<tr><td colspan="6" class="muted">لا يوجد سجلات.</td></tr>';
        return;
      }
      tableBody.innerHTML = records.map(r => `
        <tr class="${selected && selected.id === r.id ? 'selected' : ''}" onclick="selectRecord(${r.id})">
          <td>${r.id ?? ''}</td>
          <td>${r.rawSupplierName ?? ''}</td>
          <td>${r.rawBankName ?? ''}</td>
          <td>${r.amount ?? ''}</td>
          <td>${r.expiryDate ?? ''}</td>
          <td><span class="status-badge ${r.matchStatus === 'ready' ? 'status-ready' : 'status-review'}">${r.matchStatus || 'needs_review'}</span></td>
        </tr>
      `).join('');
    }

    window.selectRecord = function(id) {
      const rec = records.find(r => r.id === id);
      if (rec) showDetail(rec);
    };

    async function showDetail(r) {
      selected = r;
      renderTable();
      detailSection.style.display = 'block';
      detailMeta.textContent = `ID: ${r.id} | Session: ${r.sessionId ?? ''}`;
      setText('dSupplier', r.rawSupplierName);
      setText('dBank', r.rawBankName);
      setText('dSupplierNorm', r.normalizedSupplier);
      setText('dBankNorm', r.normalizedBank);
      setText('dAmount', r.amount);
      setText('dGuarantee', r.guaranteeNumber);
      setText('dIssue', r.issueDate);
      setText('dExpiry', r.expiryDate);
      setText('dSession', r.sessionId);
      setText('dCreated', r.createdAt);
      setText('dSupplierSuggested', r.supplierId ? `ID: ${r.supplierId}` : '—');
      setText('dBankSuggested', r.bankId ? `ID: ${r.bankId}` : '—');
      document.getElementById('fSupplier').value = r.rawSupplierName || '';
      document.getElementById('fBank').value = r.rawBankName || '';
      document.getElementById('fAmount').value = r.amount || '';
      document.getElementById('fGuarantee').value = r.guaranteeNumber || '';
      document.getElementById('fIssue').value = r.issueDate || '';
      document.getElementById('fExpiry').value = r.expiryDate || '';
      document.getElementById('fStatus').value = r.matchStatus || 'needs_review';
      decisionMsg.textContent = '';
      await renderSuggestions(r);
    }

    function setText(id, val) {
      const el = document.getElementById(id);
      if (el) el.textContent = val || '';
    }

    async function saveDecision() {
      if (!selected) return;
      const payload = {
        raw_supplier_name: document.getElementById('fSupplier').value,
        raw_bank_name: document.getElementById('fBank').value,
        amount: document.getElementById('fAmount').value,
        guarantee_number: document.getElementById('fGuarantee').value,
        issue_date: document.getElementById('fIssue').value,
        expiry_date: document.getElementById('fExpiry').value,
        match_status: document.getElementById('fStatus').value,
      };
      decisionMsg.textContent = 'جارٍ الحفظ...';
      const res = await fetch(`/api/records/${selected.id}/decision`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
      });
      const json = await res.json();
      if (!json.success) {
        decisionMsg.textContent = json.message || 'تعذر الحفظ';
        decisionMsg.className = 'alert alert-error';
        return;
      }
      decisionMsg.textContent = 'تم الحفظ';
      decisionMsg.className = 'alert alert-success';
      await loadRecords();
    }

    async function renderSuggestions(r) {
      const supplierSuggestions = document.getElementById('supplierSuggestions');
      const bankSuggestions = document.getElementById('bankSuggestions');
      supplierSuggestions.innerHTML = '<div class="muted">جارٍ تحميل المرشحين...</div>';
      bankSuggestions.innerHTML = '<div class="muted">جارٍ تحميل المرشحين...</div>';
      document.getElementById('conflicts').style.display = 'none';
      try {
        const res = await fetch(`/api/records/${r.id}/candidates`);
        const json = await res.json();
        if (!json.success) {
          supplierSuggestions.innerHTML = '<div class="alert alert-error">تعذر تحميل المرشحين</div>';
          bankSuggestions.innerHTML = '<div class="alert alert-error">تعذر تحميل المرشحين</div>';
          return;
        }
        const candidates = json.data?.supplier?.candidates || [];
        const bankCands = json.data?.bank?.candidates || [];
        const conflicts = json.data?.conflicts || [];
        const normalized = json.data?.supplier?.normalized || '';
        const bankNormalized = json.data?.bank?.normalized || '';

        supplierSuggestions.innerHTML = candidates.length ? candidates.map((c, idx) => `
          <label class="candidate">
            <input type="radio" name="supplierCandidate" value="${idx}" ${idx===0 ? 'checked' : ''} />
            <div>
              <div class="name">${c.name || '—'} <span class="tag tag-source">${c.source}</span></div>
              <div class="score">normalized: ${normalized}</div>
              <div class="score">Score: ${c.score?.toFixed(2) ?? '—'} (raw: ${c.score_raw?.toFixed(2) ?? '—'})</div>
            </div>
          </label>
        `).join('') : '<div class="muted">لا توجد اقتراحات</div>';

        bankSuggestions.innerHTML = bankCands.length ? bankCands.map((c, idx) => `
          <label class="candidate">
            <input type="radio" name="bankCandidate" value="${idx}" ${idx===0 ? 'checked' : ''} />
            <div>
              <div class="name">${c.name || '—'} <span class="tag tag-source">${c.source}</span></div>
              <div class="score">normalized: ${bankNormalized}</div>
              <div class="score">Score: ${c.score?.toFixed(2) ?? '—'} (raw: ${c.score_raw?.toFixed(2) ?? '—'})</div>
            </div>
          </label>
        `).join('') : '<div class="muted">لا توجد اقتراحات</div>';

        supplierSuggestions.querySelectorAll('input[name="supplierCandidate"]').forEach((input, idx) => {
          input.addEventListener('change', () => {
            const chosen = candidates[idx];
            document.getElementById('fSupplier').value = chosen.name || '';
          });
        });
        bankSuggestions.querySelectorAll('input[name="bankCandidate"]').forEach((input, idx) => {
          input.addEventListener('change', () => {
            const chosen = bankCands[idx];
            document.getElementById('fBank').value = chosen.name || '';
          });
        });

        const confEl = document.getElementById('conflicts');
        if (conflicts.length) {
          confEl.innerHTML = conflicts.map(c => `<div class="conflict-item">${c}</div>`).join('');
          confEl.style.display = 'block';
        } else {
          confEl.style.display = 'none';
        }
      } catch (e) {
        supplierSuggestions.innerHTML = '<div class="alert alert-error">تعذر تحميل المرشحين</div>';
        bankSuggestions.innerHTML = '<div class="alert alert-error">تعذر تحميل المرشحين</div>';
      }
    }

    document.getElementById('saveDecision').addEventListener('click', saveDecision);
    refreshBtn.addEventListener('click', loadRecords);
    loadRecords();
  </script>
</body>
</html>
