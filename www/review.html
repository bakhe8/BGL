<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة المراجعة</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body class="bg-slate-50 text-slate-800 font-[Tajawal]">
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="font-semibold text-lg">لوحة المراجعة</div>
      <nav class="flex gap-4 text-sm text-slate-600">
        <a href="/import">Import</a>
        <a href="/records">Records</a>
        <a href="/review" class="text-blue-600 font-semibold">Review Panel</a>
        <a href="/dictionary/suppliers">Dictionary</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8 space-y-6">
    <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-xl font-semibold">السجلات قيد المراجعة</h1>
        <button id="refresh" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">تحديث</button>
      </div>
      <div id="tableWrap" class="overflow-x-auto text-sm max-h-[50vh]">
        <div class="text-slate-500">لا يوجد سجلات.</div>
      </div>
    </section>

    <section id="detailSection" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">تفاصيل السجل</h2>
        <div id="detailMeta" class="text-sm text-slate-500"></div>
      </div>
      <div id="conflicts" class="mb-4 text-sm text-red-700"></div>

      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <div>
          <label class="text-slate-600">المورد</label>
          <div id="dSupplier" class="font-semibold"></div>
        </div>
        <div>
          <label class="text-slate-600">البنك</label>
          <div id="dBank" class="font-semibold"></div>
        </div>
        <div>
          <label class="text-slate-600">المورد (مطبع)</label>
          <div id="dSupplierNorm" class="text-slate-600"></div>
        </div>
        <div>
          <label class="text-slate-600">البنك (مطبع)</label>
          <div id="dBankNorm" class="text-slate-600"></div>
        </div>
        <div>
          <label class="text-slate-600">المبلغ</label>
          <div id="dAmount"></div>
        </div>
        <div>
          <label class="text-slate-600">رقم الضمان</label>
          <div id="dGuarantee"></div>
        </div>
        <div>
          <label class="text-slate-600">تاريخ الإصدار</label>
          <div id="dIssue"></div>
        </div>
        <div>
          <label class="text-slate-600">تاريخ الانتهاء</label>
          <div id="dExpiry"></div>
        </div>
        <div>
          <label class="text-slate-600">جلسة الاستيراد</label>
          <div id="dSession"></div>
        </div>
        <div>
          <label class="text-slate-600">تاريخ الإدخال</label>
          <div id="dCreated"></div>
        </div>
        <div>
          <label class="text-slate-600">مورد مقترح</label>
          <div id="dSupplierSuggested" class="text-slate-600">—</div>
        </div>
        <div>
          <label class="text-slate-600">بنك مقترح</label>
          <div id="dBankSuggested" class="text-slate-600">—</div>
        </div>
      </div>

      <hr class="my-4 border-slate-200">

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h3 class="font-semibold mb-2">اقتراحات المورد (official + alternative)</h3>
          <div id="supplierSuggestions" class="space-y-2 text-sm text-slate-700"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">اقتراحات البنك</h3>
          <div id="bankSuggestions" class="space-y-2 text-sm text-slate-700 text-slate-500">لا توجد اقتراحات بعد (سيُضاف لاحقًا).</div>
        </div>
      </div>

      <hr class="my-4 border-slate-200">

      <form id="decisionForm" class="grid md:grid-cols-2 gap-4 text-sm">
        <div>
          <label class="text-slate-600">اسم المورد (تعديل اختياري)</label>
          <input type="text" id="fSupplier" class="w-full border border-slate-300 rounded-md px-3 py-2" />
        </div>
        <div>
          <label class="text-slate-600">اسم البنك (تعديل اختياري)</label>
          <input type="text" id="fBank" class="w-full border border-slate-300 rounded-md px-3 py-2" />
        </div>
        <div>
          <label class="text-slate-600">المبلغ</label>
          <input type="text" id="fAmount" class="w-full border border-slate-300 rounded-md px-3 py-2" />
        </div>
        <div>
          <label class="text-slate-600">رقم الضمان</label>
          <input type="text" id="fGuarantee" class="w-full border border-slate-300 rounded-md px-3 py-2" />
        </div>
        <div>
          <label class="text-slate-600">تاريخ الإصدار</label>
          <input type="text" id="fIssue" class="w-full border border-slate-300 rounded-md px-3 py-2" placeholder="YYYY-MM-DD" />
        </div>
        <div>
          <label class="text-slate-600">تاريخ الانتهاء</label>
          <input type="text" id="fExpiry" class="w-full border border-slate-300 rounded-md px-3 py-2" placeholder="YYYY-MM-DD" />
        </div>
        <div>
          <label class="text-slate-600">الحالة</label>
          <select id="fStatus" class="w-full border border-slate-300 rounded-md px-3 py-2">
            <option value="needs_review">Needs Review</option>
            <option value="ready">Ready</option>
          </select>
        </div>
      </form>
      <div class="mt-4 flex items-center gap-3">
        <button id="saveDecision" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">حفظ القرار</button>
        <div id="decisionMsg" class="text-sm text-slate-600"></div>
      </div>
    </section>
  </main>

  <script>
    const tableWrap = document.getElementById('tableWrap');
    const refreshBtn = document.getElementById('refresh');
    const detailSection = document.getElementById('detailSection');
    const detailMeta = document.getElementById('detailMeta');
    const decisionForm = document.getElementById('decisionForm');
    const msg = document.getElementById('decisionMsg');

    let records = [];
    let selected = null;

    async function loadRecords() {
      tableWrap.innerHTML = '<div class="text-slate-500">جارٍ التحميل...</div>';
      const res = await fetch('/api/records');
      const json = await res.json();
      if (!json.success) {
        tableWrap.innerHTML = '<div class="text-red-600">تعذر تحميل السجلات</div>';
        return;
      }
      records = (json.data || []).filter(r => (r.matchStatus || '') === 'needs_review');
      renderTable();
      if (records.length) {
        showDetail(records[0]);
      } else {
        detailSection.classList.add('hidden');
      }
    }

    function renderTable() {
      if (!records.length) {
        tableWrap.innerHTML = '<div class="text-slate-500">لا يوجد سجلات.</div>';
        return;
      }
      const rows = records.map(r => `
        <tr class="hover:bg-gray-100 cursor-pointer" onclick="selectRecord(${r.id})">
          <td class="px-3 py-2">${r.id ?? ''}</td>
          <td class="px-3 py-2">${r.rawSupplierName ?? ''}</td>
          <td class="px-3 py-2">${r.rawBankName ?? ''}</td>
          <td class="px-3 py-2">${r.amount ?? ''}</td>
          <td class="px-3 py-2">${r.guaranteeNumber ?? ''}</td>
          <td class="px-3 py-2">${r.expiryDate ?? ''}</td>
          <td class="px-3 py-2">${statusBadge(r.matchStatus)}</td>
        </tr>
      `).join('');

      tableWrap.innerHTML = `
        <table class="min-w-full text-sm divide-y divide-slate-200">
          <thead class="bg-slate-100 text-slate-700 sticky top-0 z-10">
            <tr>
              <th class="px-3 py-2 text-right">#</th>
              <th class="px-3 py-2 text-right">المورد</th>
              <th class="px-3 py-2 text-right">البنك</th>
              <th class="px-3 py-2 text-right">المبلغ</th>
              <th class="px-3 py-2 text-right">رقم الضمان</th>
              <th class="px-3 py-2 text-right">تاريخ الانتهاء</th>
              <th class="px-3 py-2 text-right">الحالة</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            ${rows}
          </tbody>
        </table>
      `;
    }

    function statusBadge(status) {
      const s = status || 'needs_review';
      const map = {
        needs_review: { text: 'Needs Review', cls: 'bg-amber-100 text-amber-800' },
        ready: { text: 'Ready', cls: 'bg-green-100 text-green-800' },
      };
      const badge = map[s] || map.needs_review;
      return `<span class="px-2 py-1 rounded-full text-xs font-medium ${badge.cls}">${badge.text}</span>`;
    }

    window.selectRecord = function(id) {
      const rec = records.find(r => r.id === id);
      if (rec) showDetail(rec);
    };

    async function showDetail(r) {
      selected = r;
      detailSection.classList.remove('hidden');
      detailMeta.textContent = `ID: ${r.id} | Session: ${r.sessionId ?? ''}`;
      setText('dSupplier', r.rawSupplierName);
      setText('dBank', r.rawBankName);
      setText('dSupplierNorm', r.normalizedSupplier);
      setText('dBankNorm', r.normalizedBank);
      setText('dAmount', r.amount);
      setText('dGuarantee', r.guaranteeNumber);
      setText('dIssue', r.issueDate);
      setText('dExpiry', r.expiryDate);
      setText('dSession', r.sessionId);
      setText('dCreated', r.createdAt);
      setText('dSupplierSuggested', r.supplierId ? `ID: ${r.supplierId}` : '—');
      setText('dBankSuggested', r.bankId ? `ID: ${r.bankId}` : '—');

      document.getElementById('fSupplier').value = r.rawSupplierName || '';
      document.getElementById('fBank').value = r.rawBankName || '';
      document.getElementById('fAmount').value = r.amount || '';
      document.getElementById('fGuarantee').value = r.guaranteeNumber || '';
      document.getElementById('fIssue').value = r.issueDate || '';
      document.getElementById('fExpiry').value = r.expiryDate || '';
      document.getElementById('fStatus').value = r.matchStatus || 'needs_review';
      msg.textContent = '';
      await renderSuggestions(r);
    }

    function setText(id, val) {
      const el = document.getElementById(id);
      if (el) el.textContent = val || '';
    }

    async function saveDecision() {
      if (!selected) return;
      const payload = {
        raw_supplier_name: document.getElementById('fSupplier').value,
        raw_bank_name: document.getElementById('fBank').value,
        amount: document.getElementById('fAmount').value,
        guarantee_number: document.getElementById('fGuarantee').value,
        issue_date: document.getElementById('fIssue').value,
        expiry_date: document.getElementById('fExpiry').value,
        match_status: document.getElementById('fStatus').value,
      };

      msg.textContent = 'جارٍ الحفظ...';
      const res = await fetch(`/api/records/${selected.id}/decision`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
      });
      const json = await res.json();
      if (!json.success) {
        msg.textContent = json.message || 'تعذر الحفظ';
        msg.className = 'text-sm text-red-600';
        return;
      }

      msg.textContent = 'تم الحفظ';
      msg.className = 'text-sm text-green-700';
      await loadRecords();
    }

    async function renderSuggestions(r) {
      const supplierSuggestions = document.getElementById('supplierSuggestions');
      const bankSuggestions = document.getElementById('bankSuggestions');
      supplierSuggestions.innerHTML = '<div class="text-slate-500">جارٍ تحميل المرشحين...</div>';
      bankSuggestions.innerHTML = '<div class="text-slate-500">جارٍ تحميل المرشحين...</div>';

      try {
        const res = await fetch(`/api/records/${r.id}/candidates`);
        const json = await res.json();
        if (!json.success) {
          supplierSuggestions.innerHTML = '<div class="text-red-600">تعذر تحميل المرشحين</div>';
          bankSuggestions.innerHTML = '<div class="text-red-600">تعذر تحميل المرشحين</div>';
          return;
        }

        const candidates = json.data?.supplier?.candidates || [];
        const bankCands = json.data?.bank?.candidates || [];
        const conflicts = json.data?.conflicts || [];
        window.lastCandidates = candidates;
        window.lastBankCandidates = bankCands;
        window.lastConflicts = conflicts;
        const normalized = json.data?.supplier?.normalized || '';
        const bankNormalized = json.data?.bank?.normalized || '';
        setText('dSupplierNorm', normalized);
        setText('dBankNorm', bankNormalized);

        supplierSuggestions.innerHTML = candidates.length ? candidates.map((c, idx) => `
          <label class="flex items-center gap-2 border border-slate-200 rounded-md px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="supplierCandidate" value="${idx}" ${idx===0 ? 'checked' : ''} />
            <div>
              <div class="font-medium">${c.name || '—'}</div>
              <div class="text-slate-600 text-xs">المصدر: ${c.source}</div>
              <div class="text-slate-500 text-xs">normalized: ${normalized}</div>
              <div class="text-slate-500 text-xs">Score: ${c.score?.toFixed(2) ?? '—'} (raw: ${c.score_raw?.toFixed(2) ?? '—'})</div>
            </div>
          </label>
        `).join('') : '<div class="text-slate-500">لا توجد اقتراحات</div>';

        bankSuggestions.innerHTML = bankCands.length ? bankCands.map((c, idx) => `
          <label class="flex items-center gap-2 border border-slate-200 rounded-md px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="bankCandidate" value="${idx}" ${idx===0 ? 'checked' : ''} />
            <div>
              <div class="font-medium">${c.name || '—'}</div>
              <div class="text-slate-600 text-xs">المصدر: ${c.source}</div>
              <div class="text-slate-500 text-xs">normalized: ${bankNormalized}</div>
              <div class="text-slate-500 text-xs">Score: ${c.score?.toFixed(2) ?? '—'} (raw: ${c.score_raw?.toFixed(2) ?? '—'})</div>
            </div>
          </label>
        `).join('') : '<div class="text-slate-500">لا توجد اقتراحات</div>';

        supplierSuggestions.querySelectorAll('input[name="supplierCandidate"]').forEach((input, idx) => {
            input.addEventListener('change', () => {
              const chosen = candidates[idx];
              document.getElementById('fSupplier').value = chosen.name || '';
            });
        });
        bankSuggestions.querySelectorAll('input[name="bankCandidate"]').forEach((input, idx) => {
            input.addEventListener('change', () => {
              const chosen = bankCands[idx];
              document.getElementById('fBank').value = chosen.name || '';
            });
        });

        renderConflicts(conflicts);
      } catch (e) {
        supplierSuggestions.innerHTML = '<div class="text-red-600">تعذر تحميل المرشحين</div>';
        bankSuggestions.innerHTML = '<div class="text-red-600">تعذر تحميل المرشحين</div>';
      }
    }

    function renderConflicts(list) {
      const conf = list || window.lastConflicts || [];
      const el = document.getElementById('conflicts');
      el.innerHTML = conf.length ? conf.map(c => `<div>${c}</div>`).join('') : '';
    }

    document.getElementById('saveDecision').addEventListener('click', saveDecision);
    refreshBtn.addEventListener('click', loadRecords);
    loadRecords();
  </script>
</body>
</html>
