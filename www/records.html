<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>السجلات</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <header class="app-header">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="font-semibold text-lg">إدارة السجلات</div>
      <nav class="nav">
        <a href="/import">Import</a>
        <a href="/records" class="active">Records</a>
        <a href="/review">Review Panel</a>
        <a href="/dictionary">Dictionary</a>
        <a href="/settings">Settings</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8 space-y-6">
    <section class="card">
      <div class="flex items-center gap-3 flex-wrap">
        <div class="flex items-center gap-2">
          <span class="label">تصفية الحالة</span>
          <select id="statusFilter" class="input" style="width:160px;">
            <option value="all">الكل</option>
            <option value="needs_review">Needs Review</option>
            <option value="ready">Ready</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button id="refresh" class="btn btn-primary">تحديث</button>
          <button class="btn btn-ghost" disabled>فرز متقدم (لاحقًا)</button>
        </div>
        <div id="meta" class="muted text-sm"></div>
      </div>
    </section>

    <section class="card">
      <div class="flex items-center justify-between mb-3">
        <h1 class="card-title">جميع السجلات</h1>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th data-key="id">#</th>
              <th data-key="rawSupplierName">supplier_raw</th>
              <th data-key="rawBankName">bank_raw</th>
              <th data-key="amount">amount_raw</th>
              <th data-key="guaranteeNumber">رقم الضمان</th>
              <th data-key="issueDate">تاريخ الإصدار</th>
              <th data-key="expiryDate">expiry_raw</th>
              <th data-key="matchStatus">الحالة</th>
              <th data-key="sessionId">import_session_id</th>
              <th data-key="createdAt">created_at</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="11" class="muted">لا يوجد سجلات بعد.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const tableBody = document.getElementById('tableBody');
    const statusFilter = document.getElementById('statusFilter');
    const refreshBtn = document.getElementById('refresh');
    const meta = document.getElementById('meta');
    let records = [];
    let sortKey = 'id';
    let sortDir = 'desc';

    async function loadRecords() {
      tableBody.innerHTML = '<tr><td colspan="11" class="muted">جارٍ التحميل...</td></tr>';
      const res = await fetch('/api/records');
      const json = await res.json();
      if (!json.success) {
        tableBody.innerHTML = '<tr><td colspan="11" class="muted">تعذر تحميل السجلات</td></tr>';
        return;
      }
      records = json.data || [];
      render();
    }

    function applyFilter(data) {
      const f = statusFilter.value;
      if (f === 'all') return data;
      return data.filter(r => (r.matchStatus || '') === f);
    }

    function sortData(data) {
      return data.slice().sort((a, b) => {
        const va = a[sortKey];
        const vb = b[sortKey];
        if (va == null && vb == null) return 0;
        if (va == null) return sortDir === 'asc' ? -1 : 1;
        if (vb == null) return sortDir === 'asc' ? 1 : -1;
        if (!isNaN(va) && !isNaN(vb)) {
          return sortDir === 'asc' ? va - vb : vb - va;
        }
        return sortDir === 'asc'
          ? String(va).localeCompare(String(vb))
          : String(vb).localeCompare(String(va));
      });
    }

    function render() {
      const filtered = applyFilter(records);
      const data = sortData(filtered);
      meta.textContent = `الإجمالي: ${records.length} | المعروض: ${data.length}`;
      if (!data.length) {
        tableBody.innerHTML = '<tr><td colspan="11" class="muted">لا يوجد سجلات.</td></tr>';
        return;
      }
      tableBody.innerHTML = data.map(r => `
        <tr>
          <td>${r.id ?? ''}</td>
          <td>${r.rawSupplierName ?? ''}</td>
          <td>${r.rawBankName ?? ''}</td>
          <td>${r.amount ?? ''}</td>
          <td>${r.guaranteeNumber ?? ''}</td>
          <td>${r.issueDate ?? ''}</td>
          <td>${r.expiryDate ?? ''}</td>
          <td><span class="status-badge ${r.matchStatus === 'ready' ? 'status-ready' : 'status-review'}">${r.matchStatus || 'needs_review'}</span></td>
          <td>${r.sessionId ?? ''}</td>
          <td>${r.createdAt ?? ''}</td>
          <td><button class="btn btn-ghost" onclick="viewRecord(${r.id})">Review / مراجعة</button></td>
        </tr>
      `).join('');
      document.querySelectorAll('th[data-key]').forEach(th => {
        th.onclick = () => {
          const key = th.getAttribute('data-key');
          if (sortKey === key) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          else { sortKey = key; sortDir = 'asc'; }
          render();
        };
      });
    }

    window.viewRecord = function(id) {
      // Placeholder: يمكن ربطه بفتح Modal أو الانتقال للوحة المراجعة
      window.location.href = '/review#' + id;
    };

    statusFilter.addEventListener('change', render);
    refreshBtn.addEventListener('click', loadRecords);
    loadRecords();
  </script>
</body>
</html>
